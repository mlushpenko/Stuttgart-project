<!-- Resupply BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Oct 30 16:45:39 CET 2013 -->
<bpel:process name="Resupply" targetNamespace="http://resupply"
	suppressJoinFailure="yes" xmlns:tns="http://resupply"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:ns="http://www.example.org/ResupplyService/" xmlns:ns1="http://www.w3.org/2001/XMLSchema"
	xmlns:ns0="http://DefaultNamespace"  >

	<!-- Import the client WSDL -->
	<bpel:import namespace="http://DefaultNamespace" location="InventoryWSImplementation1.wsdl"
		importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:import namespace="http://www.example.org/ResupplyService/"
		location="ResupplyServiceSOAPPort.wsdl" importType="http://schemas.xmlsoap.org/wsdl/"></bpel:import>
	<bpel:import location="ResupplyArtifacts.wsdl" namespace="http://resupply"
		importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- ================================================================= -->
	<!-- PARTNERLINKS -->
	<!-- List of services participating in this BPEL process -->
	<!-- ================================================================= -->
	<bpel:partnerLinks>
		<!-- The 'client' role represents the requester of this service. -->
		<bpel:partnerLink name="client" partnerLinkType="tns:Resupply"
			myRole="ResupplyProvider" />
		<bpel:partnerLink name="ResupplyServicePL"
			partnerLinkType="tns:ResupplyServicePLT" partnerRole="ResupplyProvider"></bpel:partnerLink>
		<bpel:partnerLink name="PartnerResupply"
			partnerLinkType="tns:PartnerResupplyPLT" partnerRole="PartnerResupply"></bpel:partnerLink>
	</bpel:partnerLinks>

	<!-- ================================================================= -->
	<!-- VARIABLES -->
	<!-- List of messages and XML documents used within this BPEL process -->
	<!-- ================================================================= -->

	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:variables>
		<bpel:variable name="clientRequest" messageType="ns:enquireRequest"></bpel:variable>
		<bpel:variable name="clientResponse" messageType="ns:enquireResponse"></bpel:variable>
		<bpel:variable name="clientRequest1" messageType="ns:getPriceRequest"></bpel:variable>
		<bpel:variable name="clientResponse1" messageType="ns:getPriceResponse"></bpel:variable>
		<bpel:variable name="clientRequest2" messageType="ns:resupplyRequest"></bpel:variable>
		<bpel:variable name="clientResponse2" messageType="ns:resupplyResponse"></bpel:variable>
		<bpel:variable name="productID" type="ns1:int">
		</bpel:variable>
		<bpel:variable name="PartnerResupplyResponse"
			messageType="ns0:resupplyResponse"></bpel:variable>
		<bpel:variable name="PartnerResupplyRequest"
			messageType="ns0:resupplyRequest"></bpel:variable>
        <bpel:variable name="resupplyResult" type="ns1:int"></bpel:variable>
    </bpel:variables>
	<bpel:sequence name="main">

		<!-- Receive input from requester. Note: This maps to operation defined 
			in Resupply.wsdl -->
		<bpel:flow name="Flow">
			<bpel:sequence name="Sequence3">

				<bpel:pick name="Pick" createInstance="yes">
					<bpel:onMessage partnerLink="client" operation="InvokeEnquire"
						portType="tns:Resupply" variable="clientRequest">
						<bpel:sequence name="Sequence">
							<bpel:invoke name="Enquire" partnerLink="ResupplyServicePL"
								operation="enquire" portType="ns:ResupplyServiceSOAPPort"
								inputVariable="clientRequest" outputVariable="clientResponse"></bpel:invoke>
							<bpel:reply name="Reply" partnerLink="client"
								operation="InvokeEnquire" portType="tns:Resupply" variable="clientResponse"></bpel:reply>
							<bpel:if name="If">
								<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$clientResponse.stockAmount=0]]></bpel:condition>
								<bpel:sequence name="Sequence">
									<bpel:assign validate="no" name="set_order_amount">
										<bpel:copy>
											<bpel:from>
												<bpel:literal>
													<impl:resupply xmlns:impl="http://DefaultNamespace"
														xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
														<impl:productID>0</impl:productID>
														<impl:quantity>0</impl:quantity>
													</impl:resupply>
												</bpel:literal>
											</bpel:from>
											<bpel:to variable="PartnerResupplyRequest" part="parameters"></bpel:to>
										</bpel:copy>
										<bpel:copy>
											<bpel:from variable="productID"></bpel:from>
											<bpel:to part="parameters" variable="PartnerResupplyRequest">
												<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:productID]]></bpel:query>
											</bpel:to>
										</bpel:copy>
										<bpel:copy>
											<bpel:from>
												<bpel:literal xml:space="preserve">50</bpel:literal>
											</bpel:from>
											<bpel:to part="parameters" variable="PartnerResupplyRequest">
												<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:quantity]]></bpel:query>
											</bpel:to>
										</bpel:copy>
									</bpel:assign>
									<bpel:invoke name="Resupply_from_partner"
										partnerLink="PartnerResupply" operation="resupply"
										portType="ns0:InventoryWSImplementation1" inputVariable="PartnerResupplyRequest"
										outputVariable="PartnerResupplyResponse"></bpel:invoke>
                                    <bpel:assign validate="no" name="get_result">
                                        <bpel:copy>
                                            <bpel:from part="parameters" variable="PartnerResupplyResponse">
                                                <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:resupplyReturn]]></bpel:query>
                                            </bpel:from>
                                            <bpel:to variable="resupplyResult"></bpel:to>
                                        </bpel:copy>
                                    </bpel:assign>
                                    <bpel:if name="Succesful_resupply">
										<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$resupplyResult=50]]></bpel:condition>
										<bpel:sequence>
											<bpel:assign validate="no" name="SpecialCode">
												<bpel:copy>
													<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                               <![CDATA[$productID+123456789]]>
													</bpel:from>
													<bpel:to part="productID" variable="clientRequest"></bpel:to>
												</bpel:copy>
											</bpel:assign>
											<bpel:invoke name="UpdateDB" partnerLink="ResupplyServicePL"
												operation="enquire" portType="ns:ResupplyServiceSOAPPort"
												inputVariable="clientRequest" outputVariable="clientResponse"></bpel:invoke>
										</bpel:sequence>
									</bpel:if>

								</bpel:sequence>
							</bpel:if>
						</bpel:sequence>
					</bpel:onMessage>
					<bpel:onMessage partnerLink="client" operation="InvokeGetPrice"
						portType="tns:Resupply" variable="clientRequest1">
						<bpel:sequence name="Sequence1">
							<bpel:invoke name="GetPrice" partnerLink="ResupplyServicePL"
								operation="getPrice" portType="ns:ResupplyServiceSOAPPort"
								inputVariable="clientRequest1" outputVariable="clientResponse1"></bpel:invoke>
							<bpel:reply name="Reply1" partnerLink="client"
								operation="InvokeGetPrice" portType="tns:Resupply" variable="clientResponse1"></bpel:reply>
						</bpel:sequence>
					</bpel:onMessage>
					<bpel:onMessage partnerLink="client" operation="InvokeResupply"
						portType="tns:Resupply" variable="clientRequest2">
						<bpel:sequence name="Sequence2">
							<bpel:invoke name="Resupply" partnerLink="ResupplyServicePL"
								operation="resupply" portType="ns:ResupplyServiceSOAPPort"
								inputVariable="clientRequest2" outputVariable="clientResponse2"></bpel:invoke>
							<bpel:reply name="Reply2" partnerLink="client"
								operation="InvokeResupply" portType="tns:Resupply" variable="clientResponse2"></bpel:reply>
						</bpel:sequence>
					</bpel:onMessage>
				</bpel:pick>
			</bpel:sequence>
			<bpel:sequence name="Check_stock_amount_by_schedule">
				<bpel:while name="While">
					<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[true()]]></bpel:condition>
					<bpel:sequence>
						<bpel:wait name="Wait">
							<bpel:for><![CDATA['PT1M']]></bpel:for>
						</bpel:wait>
						<bpel:assign validate="no" name="initate_productID">
							<bpel:copy>
								<bpel:from>
									<bpel:literal xml:space="preserve">1</bpel:literal>
								</bpel:from>
								<bpel:to variable="productID"></bpel:to>
							</bpel:copy>
						</bpel:assign>
						<bpel:while name="iterate_through_all_products">
							<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$productID<4]]></bpel:condition>
							<bpel:sequence>
								<bpel:assign validate="no" name="Assign">
									<bpel:copy>
										<bpel:from variable="productID"></bpel:from>
										<bpel:to part="productID" variable="clientRequest"></bpel:to>
									</bpel:copy>
								</bpel:assign>
								<bpel:invoke name="check_availibility" partnerLink="ResupplyServicePL"
									operation="enquire" portType="ns:ResupplyServiceSOAPPort"
									inputVariable="clientRequest" outputVariable="clientResponse"></bpel:invoke>
								<bpel:if name="If_not_available">
									<bpel:condition
										expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$clientResponse.stockAmount=0]]></bpel:condition>
									<bpel:sequence>
										<bpel:assign validate="no" name="set_order_amount">
											<bpel:copy>
												<bpel:from variable="productID"></bpel:from>
												<bpel:to part="parameters" variable="PartnerResupplyRequest">
													<bpel:query
														queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:productID]]></bpel:query>
												</bpel:to>
											</bpel:copy>
											<bpel:copy>
												<bpel:from>
													<bpel:literal xml:space="preserve">50</bpel:literal>
												</bpel:from>
												<bpel:to part="parameters" variable="PartnerResupplyRequest">
													<bpel:query
														queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:quantity]]></bpel:query>
												</bpel:to>
											</bpel:copy>
										</bpel:assign>
										<bpel:invoke name="Resupply_from_partner"
											partnerLink="PartnerResupply" operation="resupply"
											portType="ns0:InventoryWSImplementation1" inputVariable="PartnerResupplyRequest"
											outputVariable="PartnerResupplyResponse"></bpel:invoke>
                                        <bpel:assign validate="no" name="get_result">
                                            <bpel:copy>
                                                <bpel:from part="parameters" variable="PartnerResupplyResponse">
                                                    <bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[ns0:resupplyReturn]]></bpel:query>
                                                </bpel:from>
                                                <bpel:to variable="resupplyResult"></bpel:to>
                                            </bpel:copy>
                                        </bpel:assign>
                                        <bpel:if name="Succesful_resupply">
											<bpel:condition expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[$resupplyResult=50]]></bpel:condition>
											<bpel:sequence>
												<bpel:assign validate="no" name="SpecialCode">
													<bpel:copy>
														<bpel:from
															expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                                                                                 <![CDATA[$productID+123456789]]>
														</bpel:from>
														<bpel:to part="productID" variable="clientRequest"></bpel:to>
													</bpel:copy>
												</bpel:assign>
												<bpel:invoke name="UpdateDB" partnerLink="ResupplyServicePL"
													operation="enquire" portType="ns:ResupplyServiceSOAPPort"
													inputVariable="clientRequest" outputVariable="clientResponse"></bpel:invoke>
											</bpel:sequence>
										</bpel:if>
									</bpel:sequence>
								</bpel:if>
								<bpel:assign validate="no" name="increase_productID">
									<bpel:copy>
										<bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                                <![CDATA[$productID+1]]>
										</bpel:from>
										<bpel:to variable="productID"></bpel:to>
									</bpel:copy>
								</bpel:assign>
							</bpel:sequence>
						</bpel:while>

					</bpel:sequence>
				</bpel:while>
			</bpel:sequence>
		</bpel:flow>

		<!-- Generate reply to synchronous request -->

	</bpel:sequence>
</bpel:process>

